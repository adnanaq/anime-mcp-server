# METADATA EXTRACTION STAGE - MULTI-SOURCE INTEGRATION
Extract metadata from Jikan, AnimSchedule, Kitsu, Anime-Planet, and AniList APIs with proper categorization merging and consistent output format.

## INPUT DATA
### JIKAN DATA:
{jikan_core_data}

### ANIMESCHEDULE DATA:
{animeschedule_data}

### KITSU DATA:
{kitsu_data}

### ANIME-PLANET DATA:
{animeplanet_data}

### ANILIST DATA:
{anilist_data}


## EXTRACTION RULES

### CATEGORIZATION & LINKS (Multi-Source Integration):
- **genres**: Extract from Jikan genres + AnimSchedule genres + Anime-Planet genres + Anilist genres (combine, no duplicates)
- **demographics**: Extract from Jikan demographics array only
- **themes**: Extract from Jikan themes + Kitsu categories + AniList tags with intelligent merging:
  1. Add all Jikan themes with their descriptions (null if no description)
  2. For each Kitsu category (first) then each AniList tag (second):
     - Skip if name exists in genres (case-insensitive comparison)
     - Skip if theme name already exists AND has description (case-insensitive comparison)
     - If theme name exists but has null description: Update that theme's description only
     - Otherwise: Add new theme with name + description
- **external_links**: Extract from all available sources (see EXTERNAL LINK PROCESSING section for details and section 4 for deduplication rules)
- **synonyms**: Extract from all sources that provide alternative titles:
  - AniList: Add all entries from synonyms array
  - Jikan: Add entries from titles.synonyms array if available
  - Kitsu: Add entries from abbreviatedTitles array if available
  - Anime-Planet: Add entries from alternative titles if available
  - AnimSchedule: Add entries from names.synonyms array if available
  - Ensure no duplication across all sources (case-insensitive comparison)
  - Skip if synonym already exists in title_japanese, title_english, or canonicalTitle
  - Combine all unique synonyms into a single array
- **images**: Extract from Jikan + AnimSchedule + Kitsu + Anime-Planet + AniList organized by image type:
  - Jikan: Extract from images.jpg.large_image_url → add to covers array
  - AnimSchedule: Extract from imageVersionRoute (prepend "https://img.animeschedule.net/production/assets/public/img/") → add to covers array
  - Kitsu: Extract with type inference:
    - posterImage.original → add to posters array
    - coverImage.original → add to covers array
  - Anime-Planet: Extract from multiple sources → add to covers array:
    - json_ld.image → add to covers array
    - opengraph.image → add to covers array (if different URL)
  - AniList: Extract with type inference:
    - coverImage.extraLarge → add to covers array
    - bannerImage → add to banners array
  - Ensure no duplication of URLs within each image type array
  - Add source attribution ("jikan", "animeschedule", "kitsu", "animeplanet", "anilist") to each image
- **source_material**: Extract from Jikan source field, use AniList source as fallback if Jikan is null/missing
- **type**: Extract from Jikan type field, use AniList format as cross-validation/fallback if Jikan is null/missing (TV, Movie, OVA, Special, etc.)
- **rating**: Extract from Jikan rating field
- **content_warnings**: Infer from Jikan rating and content

### CORE METADATA (Jikan Primary):
- **synopsis**: Extract from Jikan synopsis field or null
- **title_japanese**: Extract Japanese title from Jikan
- **title_english**: Extract English title from Jikan
- **background**: Extract background information from Jikan
- **aired_dates**: Extract aired information from Jikan (from, to, string)
- **broadcast**: Extract broadcast information from Jikan (day, time, timezone)

### ANIMESCHEDULE ENHANCEMENTS:
- **broadcast_schedule**: Extract broadcast timing information from AnimeSchedule:
  - jpn_time: AnimSchedule jpnTime field (original Japanese broadcast time)
  - sub_time: AnimSchedule subTime field (subtitled version release time)
  - dub_time: AnimSchedule dubTime field (dubbed version release time)
- **premiere_dates**: Extract premiere information from AnimeSchedule:
  - original: AnimSchedule premier field (first Japanese episode date)
  - sub: AnimSchedule subPremier field (first subtitled episode date)
  - dub: AnimSchedule dubPremier field (first dubbed episode date)
- **delay_information**: Extract delay status from AnimeSchedule:
  - delayed_timetable: AnimSchedule delayedTimetable field
  - delayed_from: AnimSchedule delayedFrom field
  - delayed_until: AnimSchedule delayedUntil field
  - delay_reason: AnimSchedule delayedDesc field (reason for delay)
- **episode_overrides**: Extract episode override information from AnimeSchedule:
  - main_override: AnimSchedule episodeOverride object (overrideDate, overrideEpisode, episodesAired)
  - sub_override: AnimSchedule subEpisodeOverride object (overrideDate, overrideEpisode, episodesAired)
  - dub_override: AnimSchedule dubEpisodeOverride object (overrideDate, overrideEpisode, episodesAired)
- **month**: Extract premiere month from AnimSchedule

### KITSU ENHANCEMENTS:
- **nsfw**: Extract from nsfw field (boolean)

### ANIME-PLANET ENHANCEMENTS:
- **episodes**: Cross-validate json_ld.numberOfEpisodes with existing episode count
- **dates**: Cross-validate json_ld.startDate/endDate with existing aired dates
- **studios**: Cross-validate studios array with existing studio data
- **images**: Extract Anime-Planet images and add to covers array:
  - json_ld.image → add to covers array with source "animeplanet"
  - opengraph.image → add to covers array with source "animeplanet" (if different URL)

### ANILIST ENHANCEMENTS:
- **source_material**: Use as fallback if Jikan source field is null/missing (Light Novel, Manga, etc.)
- **type**: Use AniList format field for cross-validation of Jikan type field (TV, Movie, OVA, Special, etc.)

### EXTERNAL LINK PROCESSING:
- **external_links**: Add platform URLs to external_links:
  - Jikan: Extract from external_links
  - AnimSchedule; Extract from websites
  - Anime-Planet: json_ld.url → add as "animeplanet" property
  - AniList: Extract from externalLinks array:
    - Extract only site and url properties
    - Convert site property to lowercase and remove all spaces to create key
    - Use url as the value
    - Skip if URL already exists in external_links from other sources
    - Examples: "Official Site" → "officialsite", "Crunchyroll" → "crunchyroll", "MyAnimeList" → "myanimelist"

## CRITICAL REQUIREMENTS

1. **INTELLIGENT CATEGORIZATION MERGING**: 
   - Combine Jikan and AnimSchedule genres, remove duplicates
   - Intelligent theme merging with case-insensitive comparison:
     - Skip Kitsu categories and AniList tags that match existing genre names
     - Skip Kitsu categories and AniList tags that match existing theme names with descriptions
     - Update existing themes with null descriptions using Kitsu/AniList descriptions
     - Add new themes from Kitsu categories and AniList tags that don't conflict
     - Process Kitsu categories first, then AniList tags to avoid race conditions

2. **PROPER THEMES STRUCTURE**: 
   - Output themes as single unified array of objects: [{"name": "Theme Name", "description": "Description or null"}]
   - Merge all themes from all sources into one array using the intelligent merging rules above
   - Each theme object format: {"name": "theme_name", "description": "description_text_or_null"}
   - Source field mappings:
     - Jikan themes: theme.name → name, null → description
     - Kitsu categories: category.attributes.title → name, category.attributes.description → description
     - AniList tags: tag.name → name, tag.description → description

3. **ORGANIZED IMAGE TYPE HANDLING**: 
   - Extract images from Jikan, AnimSchedule, Kitsu, Anime-Planet, and AniList organized by image type
   - Create separate arrays: posters, covers, banners (and potentially screenshots in future)
   - Type inference rules:
     - Kitsu posterImage.original → posters array
     - Kitsu coverImage.original → covers array
     - AniList coverImage.extraLarge → covers array
     - AniList bannerImage → banners array
     - Jikan, AnimSchedule, and Anime-Planet images → covers array
   - AnimSchedule: prepend "https://img.animeschedule.net/production/assets/public/img/" to imageVersionRoute
   - Ensure no duplication of URLs within each image type array
   - Add source attribution to each image object
   - Do not include type field in image objects (type is implied by array organization)

4. **EXTERNAL LINK DEDUPLICATION**:
   - Extract external links from all available sources (Jikan, AnimSchedule, Anime-Planet, AniList)
   - **Universal key normalization**: Convert ALL external link keys to lowercase (regardless of source)
   - Ensure no duplication of URLs or normalized property names
   - If same normalized key exists from multiple sources, keep only one instance

5. **HANDLE MISSING DATA**: 
   - If any API data is missing or null, set corresponding output fields to null
   - Continue processing with available data sources
   - Do not include statistics section (handled in separate Stage 4)

## OUTPUT FORMAT
**IMPORTANT: The values shown below are EXAMPLES ONLY. Extract actual data from the provided APIs.**

{
  "synopsis": "Edward Elric, a young, brilliant alchemist, has lost much in his twelve-year life...", // EXAMPLE - Extract actual synopsis
  "genres": ["Action", "Adventure", "Fantasy", "Drama"], // EXAMPLE - Extract actual genre names from Jikan + AnimSchedule
  "demographics": ["Shounen"], // EXAMPLE - Extract actual demographic names from Jikan
  "themes": [
    {"name": "Military", "description": null}, // EXAMPLE - From Jikan themes
    {"name": "Magic", "description": "Magic is the art of purportedly manipulating aspects of reality either by supernatural means or through knowledge of unknown occult laws."}, // EXAMPLE - From Kitsu categories
    {"name": "Violence", "description": "Physical force against self or other, compelling action against one's will on pain of being hurt."}
  ],
  "source_material": "Manga", // EXAMPLE - Extract from Jikan, fallback to AniList if null
  "rating": "R - 17+ (violence & profanity)", // EXAMPLE - Extract actual rating
  "content_warnings": ["Violence", "Strong Language"], // EXAMPLE - Extract actual content warnings
  "nsfw": false, // EXAMPLE - Extract actual nsfw flag from Kitsu
  "title_japanese": "鋼の錬金術師", // EXAMPLE - Extract actual Japanese title
  "title_english": "Fullmetal Alchemist", // EXAMPLE - Extract actual English title
  "synonyms": ["FMA", "Hagane no Renkinjutsushi", "강철의 연금술사"], // EXAMPLE - Extract actual synonyms from all sources, no duplicates
  "background": "Fullmetal Alchemist won the TV Feature Award...", // EXAMPLE - Extract actual background
  "aired_dates": {
    "from": "2003-10-04T00:00:00+00:00",
    "to": "2004-10-02T00:00:00+00:00",
    "string": "Oct 4, 2003 to Oct 2, 2004"
  }, // EXAMPLE - Extract actual aired dates
  "broadcast": {
    "day": "Saturdays",
    "time": "18:00",
    "timezone": "Asia/Tokyo"
  }, // EXAMPLE - Extract actual broadcast info
  "broadcast_schedule": {
    "jpn_time": "2024-01-01T18:00:00+09:00",
    "sub_time": "2024-01-01T19:00:00+09:00",
    "dub_time": "2024-01-01T20:00:00+09:00"
  }, // EXAMPLE - Extract actual AnimSchedule timing
  "premiere_dates": {
    "original": "2024-01-01",
    "sub": "2024-01-01",
    "dub": "2024-01-15"
  }, // EXAMPLE - Extract actual premiere dates
  "delay_information": {
    "delayed_timetable": false,
    "delayed_from": null,
    "delayed_until": null,
    "delay_reason": null
  }, // EXAMPLE - Extract actual delay info
  "episode_overrides": {
    "main_override": null,
    "sub_override": null,
    "dub_override": null
  }, // EXAMPLE - Extract actual episode overrides
  "external_links": {
    "mal": "https://myanimelist.net/anime/121",
    "official": "https://cowboy-bebop.com/",
    "crunchyroll": "https://crunchyroll.com/series/cowboy-bebop"
  }, // EXAMPLE - Extract actual external links with AniList normalized keys
  "images": {
    "posters": [
      {
        "url": "https://media.kitsu.app/anime/poster_images/100/original.jpg",
        "source": "kitsu"
      }
    ],
    "covers": [
      {
        "url": "https://media.kitsu.app/anime/cover_images/100/original.jpg",
        "source": "kitsu"
      }
    ],
    "banners": [
      {
        "url": "https://s4.anilist.co/file/anilistcdn/media/anime/banner/1-T3PJUjFJyRwg.jpg",
        "source": "anilist"
      }
    ]
  }, // EXAMPLE - Organize by image type: "posters", "covers", "banners", etc. Multiple sources can contribute to each type
  "month": "January" // EXAMPLE - Extract actual premiere month
}

**CRITICAL: Use actual data from the APIs, not the example values shown above.**

Return ONLY valid JSON with the exact fields listed above. No explanations or additional text.